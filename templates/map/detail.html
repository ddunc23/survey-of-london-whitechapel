{% extends 'map/base.html' %}

{% block content %}
<div id="small_map" {% if feature.thumbnail %} style="background: url('/media/{{ feature.banner }}'); background-size: cover; background-position: center;" {% endif %} class="hidden-sm hidden-xs"></div>
<div class="container">
	<div class="row">
		<div class="col-md-3">
		</div>
		<div class="col-xs-12 col-md-7">
			{% if feature.name %}
			<h1>{{ feature.name }}</h1>
			<h2><small>{{ feature.address }} {% if feature.year_built %}| Constructed <a href="{% url 'date_range' feature.year_built %}">{{ feature.year_built }}{% endif %}</a></small> <a href="{% url 'home' %}?highlight={{ feature.id }}" class="btn btn-default btn-sm">Show on Map</a> {% if user.is_authenticated and user.is_staff %} <a href="{% url 'admin:map_feature_change' feature.id %}" class="btn btn-default btn-sm">Edit</a>{% endif %} </h2>
			{% else %}
			<h1>{{ feature.address }}</h1>
			{% endif %}
		</div>
		<div class="col-xs-2">
		</div>
	</div>
	<div class="row">
		<div class="col-md-3"></div>
		<div class="col-xs-12 col-md-7">
			<ul class="nav nav-tabs" role="tablist" id="docTabs">
				{% if histories %}
				<li role="presentation" {% if not stories or not descriptions %}class="active"{% endif %}><a href="#history" aria-controls="home" role="tab">History</a></li>
				{% endif %}
				{% if descriptions %}
				<li role="presentation" {% if not histories %}class="active"{% endif %}><a href="#description" aria-controls="home" role="tab">Description</a></li>
				{% endif %}
				{% if stories %}
				<li role="presentation"{% if not histories and not descriptions %}class="active"{% endif %}><a href="#story" aria-controls="home" role="tab">Stories</a></li>
				{% endif %}
				
			</ul>
		</div>
	</div>
	<div class="row">
		<div class="col-md-3" id="fixed-nav">
			<ul data-spy="affix" data-offset-top="300" data-offset-bottom="0" class="nav nav-stacked hidden-sm hidden-xs">
			{% if histories %}
				{% if not stories or not descriptions %}
					{% for document in histories %}
						{% if document.start_year %}
							<li><a href="#{{ document.title|slugify }}">{{ document.title }}<br /><span class="small">{{ document.start_year }} - {{ document.end_year }}</span></a></li>
						{% else %}
							<li><a href="#{{ document.title|slugify }}">{{ document.title }}</span></a></li>
						{% endif %}
					{% endfor %}
				{% endif %}
			{% endif %}
			{% if descriptions %}
				{% if not histories %}
					{% for document in descriptions %}
						{% if document.start_year %}
							<li><a href="#{{ document.title|slugify }}">{{ document.title }}<br /><span class="small">{{ document.start_year }} - {{ document.end_year }}</span></a></li>
						{% else %}
							<li><a href="#{{ document.title|slugify }}">{{ document.title }}</span></a></li>
						{% endif %}
					{% endfor %}
				{% endif %}
			{% endif %}
			{% if stories %}
				{% if not histories and not descriptions %}
					{% for document in stories %}
						{% if document.start_year %}
							<li><a href="#{{ document.title|slugify }}">{{ document.title }}<br /><span class="small">{{ document.start_year }} - {{ document.end_year }}</span></a></li>
						{% else %}
							<li><a href="#{{ document.title|slugify }}">{{ document.title }}</span></a></li>
						{% endif %}
					{% endfor %}
				{% endif %}
			{% endif %}
			</ul>
		</div>
		<div class="col-xs-12 col-md-7 feature-detail">
			<div class="tab-content">
				<div role="tabpanel" class="tab-pane {% if not stories or not descriptions %}active{% endif %}" id="history">
				{% for document in histories %}
					<div>
						<span id="{{ document.title|slugify }}" class="detail_anchor"></span>
						<h2>{{ document.title }}</h2>
						{{ document.body|safe }}
					</div>				
				{% endfor %}
				</div>
				<div role="tabpanel" class="tab-pane {% if not histories  %}active{% endif %}" id="description">
				{% for document in descriptions %}
					<div>
						<span id="{{ document.title|slugify }}" class="detail_anchor"></span>
						<h2>{{ document.title }}</h2>
						{{ document.body|safe }}
					</div>	
				{% endfor %}
				</div>
				<div role="tabpanel" class="tab-pane {% if not histories and not descriptions %}active{% endif %}" id="story">
				{% for document in stories %}
					<div>
						<span id="{{ document.title|slugify }}" class="detail_anchor"></span>
						<h2>{{ document.title }}</h2>
						<h2><span class="small">{% if document.author.first_name and document.author.last_name %}{{ document.author.first_name }} {{ document.author.last_name }}{% else %}{{ document.author }}{% endif %}</span></h2>
						{{ document.body|safe }}
					</div>	
				{% endfor %}
				</div>
			</div>
		</div>
		<div class="col-xs-12 col-md-2">
			{% if similar %}
				<h4>Similar Places</h4>
				<ul class="list-unstyled">
				{% for feature in similar %}
					<li><a href="{% url 'detail' feature.id %}">{{ feature.name }}</a></li>
				{% endfor %}
				</ul>
			{% endif %}
			{% if feature.categories.all.0 %}
				<h4>Categories</h4>
				<ul class="list-unstyled">
				{% for category in feature.categories.all %}
					<li><a href="{% url 'category' category.name %}">{{ category }}</a></li>
				{% endfor %}
				</ul>
			{% endif %}
			{% if feature.tags %}
				<h4>Tags</h4>
				{% for tag in feature.tags.all %}
					<a href="{% url 'tag' tag %}" class="btn btn-default btn-xs tag">{{ tag }}</a> 
				{% endfor %}
			{% endif %}
		</div>
	</div>
</div>



<script>
	{% load geojson_tags %}
	feature_geojson = {{ feature|geojsonfeature:"osm_id,count,address"|safe }}

	var myStyle = {
		"color": "#2262cc",
		"weight": 1,
		"opacity": 0.8,
		"fillOpacity": 0.8,
	}

	var oslayer = L.tileLayer('http://dev.local/tileserver.php?/index.json?/OS_OpenMap_Local_Whitechapel_Crop_New_Fonts/{z}/{x}/{y}.png').setOpacity(0.9);

	var feature = L.geoJson(feature_geojson, {
		style: myStyle
	})

	var centre = feature.getBounds().getCenter();

	var map = L.map('small_map', {
		center: centre,
		zoom: 17,
		zoomControl: false,
		layers: [oslayer, feature],
	})

	map.dragging.disable();
	map.touchZoom.disable();
	map.doubleClickZoom.disable();
	map.scrollWheelZoom.disable();
	map.keyboard.disable();

	var historyNav = '{% for document in histories %}{% if document.start_year %}<li><a href="#{{ document.title|slugify }}">{{ document.start_year }} - {{ document.end_year }}<br /><span class="small">{{ document.title }}</span></a></li>{% else %}<li><a href="#{{ document.title|slugify }}">{{ document.title }}</span></a></li>{% endif %}{% endfor %}';

	var descriptionNav = '{% for document in descriptions %}{% if document.start_year %}<li><a href="#{{ document.title|slugify }}">{{ document.start_year }} - {{ document.end_year }}<br /><span class="small">{{ document.title }}</span></a></li>{% else %}<li><a href="#{{ document.title|slugify }}">{{ document.title }}</span></a></li>{% endif %}{% endfor %}';

	var storyNav = '{% for document in stories %}{% if document.start_year %}<li><a href="#{{ document.title|slugify }}">{{ document.start_year }} - {{ document.end_year }}<br /><span class="small">{{ document.title }}</span></a></li>{% else %}<li><a href="#{{ document.title|slugify }}">{{ document.title }}</span></a></li>{% endif %}{% endfor %}';

	$('#docTabs a').click(function(e) {
		e.preventDefault();
		$(this).tab('show');
		if ($(this).html() == 'Description') {
			$('#fixed-nav ul').html(descriptionNav);
		} else if ($(this).html() == 'History') {
			$('#fixed-nav ul').html(historyNav);
		} else if ($(this).html() == 'Stories') {
			$('#fixed-nav ul').html(storyNav);
		}
	})

	// Enable link to tab
	var url = document.location.toString();
	if (url.match('#')) {
		window.scroll(0, 0);
		var anchor = url.split('#')[1];
	    $('#docTabs a[href="#'+url.split('#')[1]+'"]').tab('show');
	    if (anchor == 'description') {
	    	$('#fixed-nav ul').html(descriptionNav);
	    }
	    $(document).ready(function() {
			window.scroll(0,0);
		})
	}



	// Change hash for page-reload
	$('#docTabs a').on('show.bs.tab', function (e) {
	    window.location.hash = e.target.hash;
	})

</script>

{% endblock %}